<style>
    /* Adding a specific style for the new Scan Serial button */
    .btn-barcode { 
        background: #e67e22; 
        color: white; 
        border: 2px solid #d35400; 
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    .scanning-active {
        animation: flash-red 1s infinite;
        background: #c0392b !important;
    }
    @keyframes flash-red {
        50% { opacity: 0.7; }
    }
</style>

<body>
    <div class="card">
        <h3>1. Scan Hardware</h3>
        <div id="reader"></div>
        <button id="startBtn" class="btn-primary" onclick="initScanner()" style="margin-top:10px;">Start Camera</button>

        <div id="scanResult" style="display:none;" class="result-box">
            <h4 style="margin:0;">TARGET: <span id="resCode" style="color:#d35400"></span></h4>
            
            <div style="font-size: 12px; margin-bottom:10px; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 4px;">
                <b>Brand:</b> <span id="resBrand"></span> | <b>Type:</b> <span id="resType"></span>
            </div>

            <label style="font-weight:bold; font-size: 12px;">SERIAL NUMBER:</label>
            <input type="text" id="fieldSerial" placeholder="Manual entry or use button below">
            
            <button id="barcodeBtn" class="btn-barcode" onclick="toggleBarcodeMode()">
                <span>ðŸ“·</span> SCAN SERIAL BARCODE
            </button>
            
            <label style="font-weight:bold; font-size: 12px; margin-top:10px; display:block;">CONDITION:</label>
            <select id="fieldCondition">
                <option value="Good working condition">Good working condition</option>
                <option value="For repair">For repair</option>
                <option value="Condemned">Condemned</option>
            </select>

            <button class="btn-success" onclick="saveRecord()">Confirm & Save</button>
            <button class="btn-cancel" onclick="cancelScan()">Cancel</button>
        </div>
    </div>

    <script>
        // ... DB Init same as before ...

        let isWaitingForBarcode = false;

        function toggleBarcodeMode() {
            isWaitingForBarcode = true;
            const btn = document.getElementById('barcodeBtn');
            btn.innerHTML = "âŒ› AIM AT BARCODE NOW...";
            btn.classList.add('scanning-active');
            toast("Scanner Listening for Barcode");
        }

        function initScanner() {
            document.getElementById('startBtn').style.display = 'none';
            scanner = new Html5Qrcode("reader");
            
            scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (text) => {
                const scannedText = text.trim();
                
                // Case A: Looking for a Device QR
                if (!activeAsset) {
                    selectAsset(scannedText);
                } 
                // Case B: Device found, but only capture if the specific button was pressed
                else if (isWaitingForBarcode) {
                    document.getElementById('fieldSerial').value = scannedText;
                    stopBarcodeMode();
                    if (navigator.vibrate) navigator.vibrate(100);
                    toast("SERIAL CAPTURED");
                }
            }).catch(err => alert("Camera Error: " + err));
        }

        function stopBarcodeMode() {
            isWaitingForBarcode = false;
            const btn = document.getElementById('barcodeBtn');
            btn.innerHTML = "<span>ðŸ“·</span> SCAN SERIAL BARCODE";
            btn.classList.remove('scanning-active');
        }

        async function selectAsset(code) {
            const asset = await db.assets.get(code);
            if (asset) {
                activeAsset = asset;
                document.getElementById('resCode').innerText = asset.deviceCode;
                document.getElementById('resBrand').innerText = asset.brand;
                document.getElementById('resType').innerText = asset.type;
                document.getElementById('fieldSerial').value = asset.serialNumber || "";
                
                document.getElementById('scanResult').style.display = 'block';
                stopBarcodeMode(); // Reset button state
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }
        }

        // ... Other functions (saveRecord, handleFileUpload, etc.) same as before ...
        
        // Ensure cancelScan also resets the barcode button
        function cancelScan() {
            document.getElementById('scanResult').style.display = 'none';
            activeAsset = null;
            stopBarcodeMode();
        }
    </script>
</body>
